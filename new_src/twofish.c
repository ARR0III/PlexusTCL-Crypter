/*
 * $Id: _twofish.c,v 2.12 2001/05/21 17:38:01 ams Exp $
 * Copyright 1999 Dr. Brian Gladman <brian.gladman@btinternet.com>
 * Copyright 2001 Abhijit Menon-Sen <ams@wiw.org>
 */
#include <stdint.h>

#ifndef _TWOFISH_TABLES_H_
  #define _TWOFISH_TABLES_H_

unsigned char q[2][256] = {
{
    169, 103, 179, 232, 4, 253, 163, 118, 154, 146, 128, 120, 228, 221, 209,
    56, 13, 198, 53, 152, 24, 247, 236, 108, 67, 117, 55, 38, 250, 19, 148, 72,
    242, 208, 139, 48, 132, 84, 223, 35, 25, 91, 61, 89, 243, 174, 162, 130, 99,
    1, 131, 46, 217, 81, 155, 124, 166, 235, 165, 190, 22, 12, 227, 97, 192,
    140, 58, 245, 115, 44, 37, 11, 187, 78, 137, 107, 83, 106, 180, 241, 225,
    230, 189, 69, 226, 244, 182, 102, 204, 149, 3, 86, 212, 28, 30, 215, 251,
    195, 142, 181, 233, 207, 191, 186, 234, 119, 57, 175, 51, 201, 98, 113, 129,
    121, 9, 173, 36, 205, 249, 216, 229, 197, 185, 77, 68, 8, 134, 231, 161, 29,
    170, 237, 6, 112, 178, 210, 65, 123, 160, 17, 49, 194, 39, 144, 32, 246, 96,
    255, 150, 92, 177, 171, 158, 156, 82, 27, 95, 147, 10, 239, 145, 133, 73,
    238, 45, 79, 143, 59, 71, 135, 109, 70, 214, 62, 105, 100, 42, 206, 203, 47,
    252, 151, 5, 122, 172, 127, 213, 26, 75, 14, 167, 90, 40, 20, 63, 41, 136,
    60, 76, 2, 184, 218, 176, 23, 85, 31, 138, 125, 87, 199, 141, 116, 183, 196,
    159, 114, 126, 21, 34, 18, 88, 7, 153, 52, 110, 80, 222, 104, 101, 188, 219,
    248, 200, 168, 43, 64, 220, 254, 50, 164, 202, 16, 33, 240, 211, 93, 15, 0,
    111, 157, 54, 66, 74, 94, 193, 224 
},
{  117, 243, 198, 244, 219, 123, 251, 200, 74, 211, 230, 107, 69, 125, 232,
    75, 214, 50, 216, 253, 55, 113, 241, 225, 48, 15, 248, 27, 135, 250, 6, 63,
    94, 186, 174, 91, 138, 0, 188, 157, 109, 193, 177, 14, 128, 93, 210, 213,
    160, 132, 7, 20, 181, 144, 44, 163, 178, 115, 76, 84, 146, 116, 54, 81, 56,
    176, 189, 90, 252, 96, 98, 150, 108, 66, 247, 16, 124, 40, 39, 140, 19, 149,
    156, 199, 36, 70, 59, 112, 202, 227, 133, 203, 17, 208, 147, 184, 166, 131,
    32, 255, 159, 119, 195, 204, 3, 111, 8, 191, 64, 231, 43, 226, 121, 12, 170,
    130, 65, 58, 234, 185, 228, 154, 164, 151, 126, 218, 122, 23, 102, 148, 161,
    29, 61, 240, 222, 179, 11, 114, 167, 28, 239, 209, 83, 62, 143, 51, 38, 95,
    236, 118, 42, 73, 129, 136, 238, 33, 196, 26, 235, 217, 197, 57, 153, 205,
    173, 49, 139, 1, 24, 35, 221, 31, 78, 45, 249, 72, 79, 242, 101, 142, 120,
    92, 88, 25, 141, 229, 152, 87, 103, 127, 5, 100, 175, 99, 182, 254, 245,
    183, 60, 165, 206, 233, 104, 68, 224, 77, 67, 105, 41, 46, 172, 21, 89, 168,
    10, 158, 110, 71, 223, 52, 53, 106, 207, 220, 34, 201, 192, 155, 137, 212,
    237, 171, 18, 162, 13, 82, 187, 2, 47, 169, 215, 97, 30, 180, 80, 4, 246,
    194, 22, 37, 134, 86, 85, 9, 190, 145
}
};

uint32_t m[4][256] = {
{
    3166450293UL, 3974898163UL, 538985414UL, 3014904308UL, 3671720923UL,
    33721211UL, 3806473211UL, 2661219016UL, 3385453642UL, 3570665939UL,
    404253670UL, 505323371UL, 2560101957UL, 2998024317UL, 2795950824UL,
    640071499UL, 1010587606UL, 2475919922UL, 2189618904UL, 1381144829UL,
    2071712823UL, 3149608817UL, 1532729329UL, 1195869153UL, 606354480UL,
    1364320783UL, 3132802808UL, 1246425883UL, 3216984199UL, 218984698UL,
    2964370182UL, 1970658879UL, 3537042782UL, 2105352378UL, 1717973422UL,
    976921435UL, 1499012234UL, 0UL, 3452801980UL, 437969053UL, 2930650221UL,
    2139073473UL, 724289457UL, 3200170254UL, 3772817536UL, 2324303965UL,
    993743570UL, 1684323029UL, 3638069408UL, 3890718084UL, 1600120839UL,
    454758676UL, 741130933UL, 4244419728UL, 825304876UL, 2155898275UL,
    1936927410UL, 202146163UL, 2037997388UL, 1802191188UL, 1263207058UL,
    1397975412UL, 2492763958UL, 2206408529UL, 707409464UL, 3301219504UL,
    572704957UL, 3587569754UL, 3183330300UL, 1212708960UL, 4294954594UL,
    1280051094UL, 1094809452UL, 3351766594UL, 3958056183UL, 471602192UL,
    1566401404UL, 909517352UL, 1734852647UL, 3924406156UL, 1145370899UL,
    336915093UL, 4126522268UL, 3486456007UL, 1061104932UL, 3233866566UL,
    1920129851UL, 1414818928UL, 690572490UL, 4042274275UL, 134807173UL,
    3334870987UL, 4092808977UL, 2358043856UL, 2762234259UL, 3402274488UL,
    1751661478UL, 3099086211UL, 943204384UL, 3857002239UL, 2913818271UL,
    185304183UL, 3368558019UL, 2577006540UL, 1482222851UL, 421108335UL,
    235801096UL, 2509602495UL, 1886408768UL, 4160172263UL, 1852755755UL,
    522153698UL, 3048553849UL, 151588620UL, 1633760426UL, 1465325186UL,
    2678000449UL, 2644344890UL, 286352618UL, 623234489UL, 2947538404UL,
    1162152090UL, 3755969956UL, 2745392279UL, 3941258622UL, 892688602UL,
    3991785594UL, 1128528919UL, 4177054566UL, 4227576212UL, 926405537UL,
    4210704413UL, 3267520573UL, 3031747824UL, 842161630UL, 2627498419UL,
    1448535819UL, 3823360626UL, 2273796263UL, 353704732UL, 4193860335UL,
    1667481553UL, 875866451UL, 2593817918UL, 2981184143UL, 2088554803UL,
    2290653990UL, 1027450463UL, 2711738348UL, 3840204662UL, 2172752938UL,
    2442199369UL, 252705665UL, 4008618632UL, 370565614UL, 3621221153UL,
    2543318468UL, 2779097114UL, 4278075371UL, 1835906521UL, 2021174981UL,
    3318050105UL, 488498585UL, 1987486925UL, 1044307117UL, 3419105073UL,
    3065399179UL, 4025441025UL, 303177240UL, 1616954659UL, 1785376989UL,
    1296954911UL, 3469666638UL, 3739122733UL, 1431674361UL, 2122209864UL,
    555856463UL, 50559730UL, 2694850149UL, 1583225230UL, 1515873912UL,
    1701137244UL, 1650609752UL, 4261233945UL, 101119117UL, 1077970661UL,
    4075994776UL, 859024471UL, 387420263UL, 84250239UL, 3907542533UL,
    1330609508UL, 2307484335UL, 269522275UL, 1953771446UL, 168457726UL,
    1549570805UL, 2610656439UL, 757936956UL, 808507045UL, 774785486UL,
    1229556201UL, 1179021928UL, 2004309316UL, 2829637856UL, 2526413901UL,
    673758531UL, 2846435689UL, 3654908201UL, 2256965934UL, 3520169900UL,
    4109650453UL, 2374833497UL, 3604382376UL, 3115957258UL, 1111625118UL,
    4143366510UL, 791656519UL, 3722249951UL, 589510964UL, 3435946549UL,
    4059153514UL, 3250655951UL, 2240146396UL, 2408554018UL, 1903272393UL,
    2425417920UL, 2863289243UL, 16904585UL, 2341200340UL, 1313770733UL,
    2391699371UL, 2880152082UL, 1869561506UL, 3873854477UL, 3688624722UL,
    2459073467UL, 3082270210UL, 1768540719UL, 960092585UL, 3553823959UL,
    2812748641UL, 2728570142UL, 3284375988UL, 1819034704UL, 117900548UL,
    67403766UL, 656885442UL, 2896996118UL, 3503322661UL, 1347425158UL,
    3705468758UL, 2223250005UL, 3789639945UL, 2054825406UL, 320073617UL
},
{
    2849585465UL, 1737496343UL, 3010567324UL, 3906119334UL, 67438343UL,
    4254618194UL, 2741338240UL, 1994384612UL, 2584233285UL, 2449623883UL,
    2158026976UL, 2019973722UL, 3839733679UL, 3719326314UL, 3518980963UL,
    943073834UL, 223667942UL, 3326287904UL, 895667404UL, 2562650866UL,
    404623890UL, 4146392043UL, 3973554593UL, 1819754817UL, 1136470056UL,
    1966259388UL, 936672123UL, 647727240UL, 4201647373UL, 335103044UL,
    2494692347UL, 1213890174UL, 4068082435UL, 3504639116UL, 2336732854UL,
    809247780UL, 2225465319UL, 1413573483UL, 3741769181UL, 600137824UL,
    424017405UL, 1537423930UL, 1030275778UL, 1494584717UL, 4079086828UL,
    2922473062UL, 2722000751UL, 2182502231UL, 1670713360UL, 22802415UL,
    2202908856UL, 781289094UL, 3652545901UL, 1361019779UL, 2605951658UL,
    2086886749UL, 2788911208UL, 3946839806UL, 2782277680UL, 3190127226UL,
    380087468UL, 202311945UL, 3811963120UL, 1629726631UL, 3236991120UL,
    2360338921UL, 981507485UL, 4120009820UL, 1937837068UL, 740766001UL,
    628543696UL, 199710294UL, 3145437842UL, 1323945678UL, 2314273025UL,
    1805590046UL, 1403597876UL, 1791291889UL, 3029976003UL, 4053228379UL,
    3783477063UL, 3865778200UL, 3184009762UL, 1158584472UL, 3798867743UL,
    4106859443UL, 3056563316UL, 1724643576UL, 3439303065UL, 2515145748UL,
    65886296UL, 1459084508UL, 3571551115UL, 471536917UL, 514695842UL,
    3607942099UL, 4213957346UL, 3273509064UL, 2384027230UL, 3049401388UL,
    3918088521UL, 3474112961UL, 3212744085UL, 3122691453UL, 3932426513UL,
    2005142283UL, 963495365UL, 2942994825UL, 869366908UL, 3382800753UL,
    1657733119UL, 1899477947UL, 2180714255UL, 2034087349UL, 156361185UL,
    2916892222UL, 606945087UL, 3450107510UL, 4187837781UL, 3639509634UL,
    3850780736UL, 3316545656UL, 3117229349UL, 1292146326UL, 1146451831UL,
    134876686UL, 2249412688UL, 3878746103UL, 2714974007UL, 490797818UL,
    2855559521UL, 3985395278UL, 112439472UL, 1886147668UL, 2989126515UL,
    3528604475UL, 1091280799UL, 2072707586UL, 2693322968UL, 290452467UL,
    828885963UL, 3259377447UL, 666920807UL, 2427780348UL, 539506744UL,
    4135519236UL, 1618495560UL, 4281263589UL, 2517060684UL, 1548445029UL,
    2982619947UL, 2876214926UL, 2651669058UL, 2629563893UL, 1391647707UL,
    468929098UL, 1604730173UL, 2472125604UL, 180140473UL, 4013619705UL,
    2448364307UL, 2248017928UL, 1224839569UL, 3999340054UL, 763158238UL,
    1337073953UL, 2403512753UL, 1004237426UL, 1203253039UL, 2269691839UL,
    1831644846UL, 1189331136UL, 3596041276UL, 1048943258UL, 1764338089UL,
    1685933903UL, 714375553UL, 3460902446UL, 3407333062UL, 801794409UL,
    4240686525UL, 2539430819UL, 90106088UL, 2060512749UL, 2894582225UL,
    2140013829UL, 3585762404UL, 447260069UL, 1270294054UL, 247054014UL,
    2808121223UL, 1526257109UL, 673330742UL, 336665371UL, 1071543669UL,
    695851481UL, 2292903662UL, 1009986861UL, 1281325433UL, 45529015UL,
    3096890058UL, 3663213877UL, 2963064004UL, 402408259UL, 1427801220UL,
    536235341UL, 2317113689UL, 2100867762UL, 1470903091UL, 3340292047UL,
    2381579782UL, 1953059667UL, 3077872539UL, 3304429463UL, 2673257901UL,
    1926947811UL, 2127948522UL, 357233908UL, 580816783UL, 312650667UL,
    1481532002UL, 132669279UL, 2581929245UL, 876159779UL, 1858205430UL,
    1346661484UL, 3730649650UL, 1752319558UL, 1697030304UL, 3163803085UL,
    3674462938UL, 4173773498UL, 3371867806UL, 2827146966UL, 735014510UL,
    1079013488UL, 3706422661UL, 4269083146UL, 847942547UL, 2760761311UL,
    3393988905UL, 269753372UL, 561240023UL, 4039947444UL, 3540636884UL,
    1561365130UL, 266490193UL, 0UL, 1872369945UL, 2648709658UL, 915379348UL,
    1122420679UL, 1257032137UL, 1593692882UL, 3249241983UL, 3772295336UL
},
{
    3161832498UL, 3975408673UL, 549855299UL, 3019158473UL, 3671841283UL,
    41616011UL, 3808158251UL, 2663948026UL, 3377121772UL, 3570652169UL,
    417732715UL, 510336671UL, 2554697742UL, 2994582072UL, 2800264914UL,
    642459319UL, 1020673111UL, 2469565322UL, 2195227374UL, 1392333464UL,
    2067233748UL, 3144792887UL, 1542544279UL, 1205946243UL, 607134780UL,
    1359958498UL, 3136862918UL, 1243302643UL, 3213344584UL, 234491248UL,
    2953228467UL, 1967093214UL, 3529429757UL, 2109373728UL, 1722705457UL,
    979057315UL, 1502239004UL, 0UL, 3451702675UL, 446503648UL, 2926423596UL,
    2143387563UL, 733031367UL, 3188637369UL, 3766542496UL, 2321386000UL,
    1003633490UL, 1691706554UL, 3634419848UL, 3884246949UL, 1594318824UL,
    454302481UL, 750070978UL, 4237360308UL, 824979751UL, 2158198885UL,
    1941074730UL, 208866433UL, 2035054943UL, 1800694593UL, 1267878658UL,
    1400132457UL, 2486604943UL, 2203157279UL, 708323894UL, 3299919004UL,
    582820552UL, 3579500024UL, 3187457475UL, 1214269560UL, 4284678094UL,
    1284918279UL, 1097613687UL, 3343042534UL, 3958893348UL, 470817812UL,
    1568431459UL, 908604962UL, 1730635712UL, 3918326191UL, 1142113529UL,
    345314538UL, 4120704443UL, 3485978392UL, 1059340077UL, 3225862371UL,
    1916498651UL, 1416647788UL, 701114700UL, 4041470005UL, 142936318UL,
    3335243287UL, 4078039887UL, 2362477796UL, 2761139289UL, 3401108118UL,
    1755736123UL, 3095640141UL, 941635624UL, 3858752814UL, 2912922966UL,
    192351108UL, 3368273949UL, 2580322815UL, 1476614381UL, 426711450UL,
    235408906UL, 2512360830UL, 1883271248UL, 4159174448UL, 1848340175UL,
    534912878UL, 3044652349UL, 151783695UL, 1638555956UL, 1468159766UL,
    2671877899UL, 2637864320UL, 300552548UL, 632890829UL, 2951000029UL,
    1167738120UL, 3752124301UL, 2744623964UL, 3934186197UL, 903492952UL,
    3984256464UL, 1125598204UL, 4167497931UL, 4220844977UL, 933312467UL,
    4196268608UL, 3258827368UL, 3035673804UL, 853422685UL, 2629016689UL,
    1443583719UL, 3815957466UL, 2275903328UL, 354161947UL, 4193253690UL,
    1674666943UL, 877868201UL, 2587794053UL, 2978984258UL, 2083749073UL,
    2284226715UL, 1029651878UL, 2716639703UL, 3832997087UL, 2167046548UL,
    2437517569UL, 260116475UL, 4001951402UL, 384702049UL, 3609319283UL,
    2546243573UL, 2769986984UL, 4276878911UL, 1842965941UL, 2026207406UL,
    3308897645UL, 496573925UL, 1993176740UL, 1051541212UL, 3409038183UL,
    3062609479UL, 4009881435UL, 303567390UL, 1612931269UL, 1792895664UL,
    1293897206UL, 3461271273UL, 3727548028UL, 1442403741UL, 2118680154UL,
    558834098UL, 66192250UL, 2691014694UL, 1586388505UL, 1517836902UL,
    1700554059UL, 1649959502UL, 4246338885UL, 109905652UL, 1088766086UL,
    4070109886UL, 861352876UL, 392632208UL, 92210574UL, 3892701278UL,
    1331974013UL, 2309982570UL, 274927765UL, 1958114351UL, 184420981UL,
    1559583890UL, 2612501364UL, 758918451UL, 816132310UL, 785264201UL,
    1240025481UL, 1181238898UL, 2000975701UL, 2833295576UL, 2521667076UL,
    675489981UL, 2842274089UL, 3643398521UL, 2251196049UL, 3517763975UL,
    4095079498UL, 2371456277UL, 3601389186UL, 3104487868UL, 1117667853UL,
    4134467265UL, 793194424UL, 3722435846UL, 590619449UL, 3426077794UL,
    4050317764UL, 3251618066UL, 2245821931UL, 2401406878UL, 1909027233UL,
    2428539120UL, 2862328403UL, 25756145UL, 2345962465UL, 1324174988UL,
    2393607791UL, 2870127522UL, 1872916286UL, 3859670612UL, 3679640562UL,
    2461766267UL, 3070408630UL, 1764714954UL, 967391705UL, 3554136844UL,
    2808194851UL, 2719916717UL, 3283403673UL, 1817209924UL, 117704453UL,
    83231871UL, 667035462UL, 2887167143UL, 3492139126UL, 1350979603UL,
    3696680183UL, 2220196890UL, 3775521105UL, 2059303461UL, 328274927UL
},
{
    3644434905UL, 2417452944UL, 1906094961UL, 3534153938UL, 84345861UL,
    2555575704UL, 1702929253UL, 3756291807UL, 138779144UL, 38507010UL,
    2699067552UL, 1717205094UL, 3719292125UL, 2959793584UL, 3210990015UL,
    908736566UL, 1424362836UL, 1126221379UL, 1657550178UL, 3203569854UL,
    504502302UL, 619444004UL, 3617713367UL, 2000776311UL, 3173532605UL,
    851211570UL, 3564845012UL, 2609391259UL, 1879964272UL, 4181988345UL,
    2986054833UL, 1518225498UL, 2047079034UL, 3834433764UL, 1203145543UL,
    1009004604UL, 2783413413UL, 1097552961UL, 115203846UL, 3311412165UL,
    1174214981UL, 2738510755UL, 1757560168UL, 361584917UL, 569176865UL,
    828812849UL, 1047503422UL, 374833686UL, 2500879253UL, 1542390107UL,
    1303937869UL, 2441490065UL, 3043875253UL, 528699679UL, 1403689811UL,
    1667071075UL, 996714043UL, 1073670975UL, 3593512406UL, 628801061UL,
    2813073063UL, 252251151UL, 904979253UL, 598171939UL, 4036018416UL,
    2951318703UL, 2157787776UL, 2455565714UL, 2165076865UL, 657533991UL,
    1993352566UL, 3881176039UL, 2073213819UL, 3922611945UL, 4043409905UL,
    2669570975UL, 2838778793UL, 3304155844UL, 2579739801UL, 2539385239UL,
    2202526083UL, 1796793963UL, 3357720008UL, 244860174UL, 1847583342UL,
    3384014025UL, 796177967UL, 3422054091UL, 4288269567UL, 3927217642UL,
    3981968365UL, 4158412535UL, 3784037601UL, 454368283UL, 2913083053UL,
    215209740UL, 736295723UL, 499696413UL, 425627161UL, 3257710018UL,
    2303322505UL, 314691346UL, 2123743102UL, 545110560UL, 1678895716UL,
    2215344004UL, 1841641837UL, 1787408234UL, 3514577873UL, 2708588961UL,
    3472843470UL, 935031095UL, 4212097531UL, 1035303229UL, 1373702481UL,
    3695095260UL, 759112749UL, 2759249316UL, 2639657373UL, 4001552622UL,
    2252400006UL, 2927150510UL, 3441801677UL, 76958980UL, 1433879637UL,
    168691722UL, 324044307UL, 821552944UL, 3543638483UL, 1090133312UL,
    878815796UL, 2353982860UL, 3014657715UL, 1817473132UL, 712225322UL,
    1379652178UL, 194986251UL, 2332195723UL, 2295898248UL, 1341329743UL,
    1741369703UL, 1177010758UL, 3227985856UL, 3036450996UL, 674766888UL,
    2131031679UL, 2018009208UL, 786825006UL, 122459655UL, 1264933963UL,
    3341529543UL, 1871620975UL, 222469645UL, 3153435835UL, 4074459890UL,
    4081720307UL, 2789040038UL, 1503957849UL, 3166243516UL, 989458234UL,
    4011037167UL, 4261971454UL, 26298625UL, 1628892769UL, 2094935420UL,
    2988527538UL, 1118932802UL, 3681696731UL, 3090106296UL, 1220511560UL,
    749628716UL, 3821029091UL, 1463604823UL, 2241478277UL, 698968361UL,
    2102355069UL, 2491493012UL, 1227804233UL, 398904087UL, 3395891146UL,
    3284008131UL, 1554224988UL, 1592264030UL, 3505224400UL, 2278665351UL,
    2382725006UL, 3127170490UL, 2829392552UL, 3072740279UL, 3116240569UL,
    1619502944UL, 4174732024UL, 573974562UL, 286987281UL, 3732226014UL,
    2044275065UL, 2867759274UL, 858602547UL, 1601784927UL, 3065447094UL,
    2529867926UL, 1479924312UL, 2630135964UL, 4232255484UL, 444880154UL,
    4132249590UL, 475630108UL, 951221560UL, 2889045932UL, 416270104UL,
    4094070260UL, 1767076969UL, 1956362100UL, 4120364277UL, 1454219094UL,
    3672339162UL, 3588914901UL, 1257510218UL, 2660180638UL, 2729120418UL,
    1315067982UL, 3898542056UL, 3843922405UL, 958608441UL, 3254152897UL,
    1147949124UL, 1563614813UL, 1917216882UL, 648045862UL, 2479733907UL,
    64674563UL, 3334142150UL, 4204710138UL, 2195105922UL, 3480103887UL,
    1349533776UL, 3951418603UL, 1963654773UL, 2324902538UL, 2380244109UL,
    1277807180UL, 337383444UL, 1943478643UL, 3434410188UL, 164942601UL,
    277503248UL, 3796963298UL, 0UL, 2585358234UL, 3759840736UL, 2408855183UL,
    3871818470UL, 3972614892UL, 4258422525UL, 2877276587UL, 3634946264UL
}
};

#endif

#ifndef _TWOFISH_H_
  #define _TWOFISH_H_

  typedef struct {
    int len;                    /* Key length in 64-bit units: 2, 3 or 4 */
    uint32_t K[40];             /* Expanded key                          */
    uint32_t S[4][256];         /* Key-dependent S-boxes                 */
  } TWOFISH_CTX;

#endif

#define byte(x,n)   ((unsigned char)((x) >> (8 * (n))))

#define ror(x,n)    (((x) >> ((int)(n))) | ((x) << (32 - (int)(n))))

#define rol(x,n)    (((x) << ((int)(n))) | ((x) >> (32 - (int)(n))))

#define strtonl(s) (uint32_t)(*(s) | *((s) + 1) << 8 | *((s) + 2) << 16 | *((s) + 3) << 24)

#define nltostr(l, s) \
    do {                                    \
        *(s  )=(unsigned char)((l)      );  \
        *(s+1)=(unsigned char)((l) >>  8);  \
        *(s+2)=(unsigned char)((l) >> 16);  \
        *(s+3)=(unsigned char)((l) >> 24);  \
    } while (0)

uint32_t mds_rem(uint32_t a, uint32_t b);
uint32_t h(int len, const int x, unsigned char *key, int odd);

/* The key schedule takes a 128, 192, or 256-bit key, and provides 40
   32-bit words of expanded key K0,...,K39 and the 4 key-dependent
   S-boxes used in the g function. */

void twofish_init(TWOFISH_CTX * ctx, unsigned char *key, int len) {
    int i;
    uint32_t a, b, x;
    unsigned char *s, skey[16];

    /* The key consists of k=len/8 (2, 3 or 4) 64-bit units. */
    ctx->len = len /= 8;
    s = skey + 4 * (len - 1);
    
    for (i = 0; i < len; i++) {
        x = mds_rem(strtonl(key + 8 * i), strtonl(key + 8 * i + 4));
        nltostr(x, s);
        s -= 4;
    }
    
    s = skey;

    for (i = 0; i < 40; i += 2) {
        a = h(len, i, key, 0);
        b = rol(h(len, i + 1, key, 1), 8);

        ctx->K[i]   = a + b;
        ctx->K[i+1] = rol(a + 2 * b, 9);
    } 

    switch(len) {
    case 2:
        for (i = 0; i < 256; i++) {
            x = (unsigned char)i;
            ctx->S[0][i] = m[0][q[0][q[0][x]^s[4]]^s[0]];
            ctx->S[1][i] = m[1][q[0][q[1][x]^s[5]]^s[1]];
            ctx->S[2][i] = m[2][q[1][q[0][x]^s[6]]^s[2]];
            ctx->S[3][i] = m[3][q[1][q[1][x]^s[7]]^s[3]];
        }
        break;
    case 3:
        for (i = 0; i < 256; i++) {
            x = (unsigned char)i;
            ctx->S[0][i] = m[0][q[0][q[0][q[1][x]^s[ 8]]^s[4]]^s[0]];
            ctx->S[1][i] = m[1][q[0][q[1][q[1][x]^s[ 9]]^s[5]]^s[1]];
            ctx->S[2][i] = m[2][q[1][q[0][q[0][x]^s[10]]^s[6]]^s[2]];
            ctx->S[3][i] = m[3][q[1][q[1][q[0][x]^s[11]]^s[7]]^s[3]];

        }
        break;
    case 4:
        for (i = 0; i < 256; i++) {
            x = (unsigned char)i;
            ctx->S[0][i] = m[0][q[0][q[0][q[1][q[1][x]^s[12]]^s[ 8]]^s[4]]^s[0]];
            ctx->S[1][i] = m[1][q[0][q[1][q[1][q[0][x]^s[13]]^s[ 9]]^s[5]]^s[1]];
            ctx->S[2][i] = m[2][q[1][q[0][q[0][q[0][x]^s[14]]^s[10]]^s[6]]^s[2]];
            ctx->S[3][i] = m[3][q[1][q[1][q[0][q[1][x]^s[15]]^s[11]]^s[7]]^s[3]];
        }
        break;
    }
}

#define g0(x) \
    ctx->S[0][byte(x,0)] ^ ctx->S[1][byte(x,1)] ^ ctx->S[2][byte(x,2)] ^ ctx->S[3][byte(x,3)]

#define g1(x) \
    ctx->S[0][byte(x,3)] ^ ctx->S[1][byte(x,0)] ^ ctx->S[2][byte(x,1)] ^ ctx->S[3][byte(x,2)]

#define f_2rounds(i)                                    \
    t0   = g0(R[0]);                                    \
    t1   = g1(R[1]);                                    \
    R[2] = ror(R[2] ^ (t0 + t1 + ctx->K[4*i+8]), 1);    \
    R[3] = rol(R[3], 1) ^ (t0 + 2*t1 + ctx->K[4*i+9]);  \
    t0   = g0(R[2]);                                    \
    t1   = g1(R[3]);                                    \
    R[0] = ror(R[0] ^ (t0 + t1 + ctx->K[4*i+10]), 1);   \
    R[1] = rol(R[1], 1) ^ (t0 + 2*t1 + ctx->K[4*i+11]);

#define i_2rounds(i)                                    \
    t0   = g0(R[0]);                                    \
    t1   = g1(R[1]);                                    \
    R[2] = rol(R[2], 1) ^ (t0 + t1 + ctx->K[4*i+10]);   \
    R[3] = ror(R[3] ^ (t0 + 2*t1 + ctx->K[4*i+11]), 1); \
    t0   = g0(R[2]);                                    \
    t1   = g1(R[3]);                                    \
    R[0] = rol(R[0], 1) ^ (t0 + t1 + ctx->K[4*i+8]);    \
    R[1] = ror(R[1] ^ (t0 + 2*t1 + ctx->K[4*i+9]), 1)


void twofish_crypt(TWOFISH_CTX * ctx,
                   unsigned char *input,
                   unsigned char *output, int crypt) {
    uint32_t t0, t1, R[4], out[4];

    if (0 == crypt) {
        R[0] = ctx->K[0] ^ strtonl(input);
        R[1] = ctx->K[1] ^ strtonl(input+4);
        R[2] = ctx->K[2] ^ strtonl(input+8);
        R[3] = ctx->K[3] ^ strtonl(input+12);

        f_2rounds(0); f_2rounds(1); f_2rounds(2); f_2rounds(3);
        f_2rounds(4); f_2rounds(5); f_2rounds(6); f_2rounds(7);

        out[0] = ctx->K[4] ^ R[2];
        out[1] = ctx->K[5] ^ R[3];
        out[2] = ctx->K[6] ^ R[0];
        out[3] = ctx->K[7] ^ R[1];
    }
    else {
        R[0] = ctx->K[4] ^ strtonl(input);
        R[1] = ctx->K[5] ^ strtonl(input+4);
        R[2] = ctx->K[6] ^ strtonl(input+8);
        R[3] = ctx->K[7] ^ strtonl(input+12);

        i_2rounds(7); i_2rounds(6); i_2rounds(5); i_2rounds(4);
        i_2rounds(3); i_2rounds(2); i_2rounds(1); i_2rounds(0);

        out[0] = ctx->K[0] ^ R[2];
        out[1] = ctx->K[1] ^ R[3];
        out[2] = ctx->K[2] ^ R[0];
        out[3] = ctx->K[3] ^ R[1];
    }

    nltostr(out[0], output);
    nltostr(out[1], output+4);
    nltostr(out[2], output+8);
    nltostr(out[3], output+12);
}

#define Lbyte(w, b) L[4*(2*w+odd)+b]

uint32_t h(int len, const int X, unsigned char *L, int odd) {
    unsigned char b0, b1, b2, b3;

    b0 = b1 = b2 = b3 = (unsigned char)X;

    switch (len) {
    case 4:
        b0 = q[1][b0] ^ Lbyte(3, 0);
        b1 = q[0][b1] ^ Lbyte(3, 1);
        b2 = q[0][b2] ^ Lbyte(3, 2);
        b3 = q[1][b3] ^ Lbyte(3, 3);
    case 3:
        b0 = q[1][b0] ^ Lbyte(2, 0);
        b1 = q[1][b1] ^ Lbyte(2, 1);
        b2 = q[0][b2] ^ Lbyte(2, 2);
        b3 = q[0][b3] ^ Lbyte(2, 3);
    case 2:
        b0 = q[0][q[0][b0] ^ Lbyte(1, 0)] ^ Lbyte(0, 0);
        b1 = q[0][q[1][b1] ^ Lbyte(1, 1)] ^ Lbyte(0, 1);
        b2 = q[1][q[0][b2] ^ Lbyte(1, 2)] ^ Lbyte(0, 2);
        b3 = q[1][q[1][b3] ^ Lbyte(1, 3)] ^ Lbyte(0, 3);
    }

    return m[0][b0] ^ m[1][b1] ^ m[2][b2] ^ m[3][b3];
}

uint32_t mds_rem(uint32_t a, uint32_t b) {
    uint32_t t, u;
    uint32_t G_MOD = 0x0000014d;

    for (int i = 0; i < 8; i++) {
        t = b >> 24;
        b = (b << 8) | (a >> 24);
        a <<= 8;
        u = t << 1;
        
        if (t & 0x80) {
            u ^= G_MOD;
        }

        b ^= t ^ (u << 16);
        u ^= t >> 1;

        if (t & 0x01) {
            u ^= G_MOD >> 1;
        }

        b ^= (u << 24) | (u << 8);
    }

    return b;
}
